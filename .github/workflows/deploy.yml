name: Manual Deploy to Production

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'The image tag to deploy (e.g., "latest" or "v1.0.1")'
        required: true
        type: string
        default: 'latest'

jobs:
  deploy:
    name: Deploy to Oracle VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SSH key and add known_hosts
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # The action will automatically run ssh-keyscan for this host
          known_hosts: ${{ secrets.SSH_HOST }}

      - name: Copy configuration to server
        run: |
          # Copy the main configuration files to the server.
          # The new Caddyfile is now included here.
          scp -o StrictHostKeyChecking=no infrastructure/docker/docker-compose.yml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/app/docker-compose.yml
          scp -o StrictHostKeyChecking=no infrastructure/docker/Caddyfile ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/app/Caddyfile
          scp -o StrictHostKeyChecking=no evochora.conf ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/app/evochora.conf

      - name: Create .env file and Deploy with Docker Compose
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            set -e # Exit immediately if a command exits with a non-zero status.
            cd ~/app
            
            # Create the .env file from GitHub Secrets and server environment
            echo "DOMAIN_NAME=${{ secrets.DOMAIN_NAME }}" > .env
            echo "IMAGE_TAG=${{ github.event.inputs.tag }}" >> .env
            echo "UID=$(id -u)" >> .env
            echo "GID=$(id -g)" >> .env
            
            # Pull the new image version from the registry
            docker compose pull
            
            # Stop and restart the service(s).
            # docker-compose will now use UID and GID from the .env file.
            docker compose up -d
          EOF
