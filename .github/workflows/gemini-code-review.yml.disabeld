name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetches all history for git diff

      - name: Get PR diff and write to file
        id: pr_diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

      - name: Setup Gemini CLI
        uses: google-github-actions/run-gemini-cli@v0.1.15
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}

      - name: Generate Review Comment
        id: review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Safely construct the prompt in a temporary file
          cat << 'EOT' > prompt.txt
          You are an expert AI code reviewer. Your review process follows a two-level hierarchy of guidelines.

          **Level 1: General Rules of Engagement & Scope**
          First, you MUST adhere to the overall agent guidelines for this project. These define the scope of allowed changes, communication style, and general principles.
          ---
          EOT

          # Append the general agent guidelines
          cat AGENTS.md >> prompt.txt

          # Append the second level of instructions
          cat << 'EOT' >> prompt.txt

          ---

          **Level 2: Specific Architectural & Technical Review Checklist**
          Now, for the detailed technical analysis of the code changes, you MUST strictly follow the specific architectural guidelines provided below. This is your primary checklist for the review itself.
          ---
          EOT

          # Append the specific architectural guidelines
          cat .agents/architecture-guidelines.md >> prompt.txt

          # Append the final instruction with the code diff
          cat << 'EOT' >> prompt.txt

          ---

          Based on **both** sets of guidelines above, please perform a comprehensive review of the following code changes.

          **Code Changes (Diff):**
          ```diff
          EOT

          # Append the diff from the file
          cat pr_diff.txt >> prompt.txt

          echo '```' >> prompt.txt

          # Generate the review by piping the prompt file into the gemini command
          REVIEW_COMMENT=$(cat prompt.txt | gemini)

          # Make the comment available to the next step
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ github.token }}
          REVIEW_COMMENT: ${{ steps.review.outputs.comment }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "$REVIEW_COMMENT"
