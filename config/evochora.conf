# ┌─────────────────────────────────────────────────────────────────────────┐
# │  Evochora Experiment Configuration                                      │
# │                                                                         │
# │  This file configures the most common experiment parameters.            │
# │  All defaults are defined in reference.conf (embedded in JAR).          │
# │  Full reference:                                                        |
# |   https://github.com/EVOCHORA/evochora/blob/main/src/main/resources/reference.conf
# │                                                                         │
# │  To create a new experiment:                                            │
# │    1. Copy this file (e.g. cp evochora.conf my-experiment.conf)         │
# │    2. Adjust the parameters below                                       │
# │    3. Start with: evochora -c config/my-experiment.conf node run        │
# └─────────────────────────────────────────────────────────────────────────┘

# Tuning profile: controls sampling, batching, and flush intervals.
# Available profiles: detailed, sampled, sparse
# See reference.conf for profile definitions and values.
pipeline.tuning = ${profiles.detailed}

pipeline {
  autoStart = true # Automatically start the pipeline when the node starts

  services {
    simulation-engine {
      options {

        # Experiment metadata
        metadata {
          experiment = "test-run" # give your experiment a name
        }

        # Initial organisms
        organisms = [
          {
            program = "assembly/primordial/main.evo"  # EvoASM the primordial should execute
            initialEnergy = 100000                    # Initial energy of the primordial
            placement {
              positions = [175, 135]                  # Starting position of the primordial's IP
            }
          }
        ]

        # Environment configuration
        environment {
          shape = [2400, 1350]  # Size of the environment grid
          topology = "TORUS"    # TORUS or BOUND topology of the grid
        }

        #pauseTicks = [100000] # Optional: Pause simulation at specific ticks for debugging
        seed = 42 # Random seed for reproducible simulations (omit for random seed)
        
        runtime {
          organism {
            max-energy = 150000      # maximum energy an organism can store (ER register)
            max-entropy = 10000      # maximum entropy before organism dies (SR register)
            error-penalty-cost = 100 # energy penalty when an instruction fails
            max-skips-per-tick = 100 # maximum instant-skip instructions (NOP, LABEL) per tick
          }

          # Thermodynamic Policy System — energy costs and entropy changes per instruction
          thermodynamics {
            default: { # applies to all instructions unless overridden below
              className = "org.evochora.runtime.thermodynamics.impl.UniversalThermodynamicPolicy"
              options: {
                base-energy = 1  # flat energy cost per instruction
                base-entropy = 1 # flat entropy increase per instruction
              }
            }

            overrides: {
              instructions: {
                "PEEK, PEKI, PEKS, POKE, POKI, POKS, PPKR, PPKI, PPKS": { # environment interaction
                  className = "org.evochora.runtime.thermodynamics.impl.UniversalThermodynamicPolicy"
                  options: {
                    base-energy = 0  # no flat cost — cost comes from read/write rules below
                    base-entropy = 0

                    read-rules: { # costs when reading a cell (PEEK, PPK)
                      own: { # reading own cells — cheap
                        _default:  { energy = 1,              entropy = 1 }
                        ENERGY:    { energy-permille = -1000, entropy = 0 } # PEEKing ENERGY provides energy
                        STRUCTURE: { energy-permille = 1000,  entropy = 1 }
                        CODE:      { energy = 1,              entropy = 1 }
                        DATA:      { energy = 1,              entropy = 1 }
                        LABEL:     { energy = 1,              entropy = 1 }
                        LABELREF:  { energy = 1,              entropy = 1 }
                        REGISTER:  { energy = 1,              entropy = 1 }
                      }
                      foreign: { # reading another organism's cells — expensive
                        _default:  { energy = 500,            entropy = 500 }
                        ENERGY:    { energy-permille = -1000, entropy = 0 } # PEEKing ENERGY provides energy
                        STRUCTURE: { energy-permille = 10000,  entropy-permille = 10000 }
                        CODE:      { energy = 500,            entropy = 500 }
                        DATA:      { energy = 500,            entropy = 500 }
                        LABEL:     { energy = 500,            entropy = 500 }
                        LABELREF:  { energy = 500,            entropy = 500 }
                        REGISTER:  { energy = 500,            entropy = 500 }
                      }
                      unowned: { # reading unowned cells — moderate
                        _default:  { energy = 5,              entropy = 5 }
                        ENERGY:    { energy-permille = -1000, entropy = 0 } # PEEKing ENERGY provides energy
                        STRUCTURE: { energy-permille = 1000,  entropy = 5 }
                        CODE:      { energy = 5,              entropy = 5, values: { "0": { energy = 0, entropy = 0 } } }
                        DATA:      { energy = 5,              entropy = 5 }
                        LABEL:     { energy = 5,              entropy = 5 }
                        LABELREF:  { energy = 5,              entropy = 5 }
                        REGISTER:  { energy = 5,              entropy = 5 }
                      }
                    }

                    write-rules: { # costs when writing a molecule (POKE, PPK) — entropy is negative (writing reduces entropy)
                      _default:  { energy = 5,              entropy = -500 } # POKEing costs energy, but depletes entropy
                      ENERGY:    { energy-permille = 1000,  entropy = -500 }
                      STRUCTURE: { energy-permille = 1000,  entropy = -500 }
                      CODE:      { energy = 5,              entropy = -500, values: { "0": { energy = 0, entropy = 0 } } }
                      DATA:      { energy = 5,              entropy = -500 }
                      LABEL:     { energy = 5,              entropy = -500 }
                      LABELREF:  { energy = 5,              entropy = -500 }
                      REGISTER:  { energy = 5,              entropy = -500 }
                    }
                  }
                }
              }
              families: {} # overrides for full instruction families
            }
          }
        }

        # Plugins — LabelRewritePlugin is appended automatically via ${pipeline.core-plugins}
        plugins = [

          # --- World Generation (run each tick) --------------------------------------------
          { # Seeds empty cells with energy at tick 0
            className = "org.evochora.runtime.worldgen.SeedEnergyCreator"
            options {
              percentage = 0.0025    # fraction of empty cells to seed
              amount = 10000         # energy units per seeded cell
              amountVariance = 0.2   # ±20% random variation
            }
          },
          { # Places geysers that erupt energy at regular intervals
            className = "org.evochora.runtime.worldgen.GeyserCreator"
            options {
              percentage = 0.0002  # fraction of cells to place as geyser sources
              interval = 100       # ticks between eruptions
              amount = 10000       # energy per eruption
              safetyRadius = 3     # cells around geyser that must be unowned
            }
          },
          { # Randomly spawns energy in unowned cells each tick
            className = "org.evochora.runtime.worldgen.SolarRadiationCreator"
            options {
              probability = 0.02     # chance per attempt to spawn energy
              amount = 10000         # energy units when spawn succeeds
              safetyRadius = 1       # cells around spawn that must be unowned
              executionsPerTick = 1  # independent spawn attempts per tick
            }
          },

          # --- Death Handler (runs on organism death)---------------------------------------
          { # Replaces dead organism's molecules with a configurable type
            className = "org.evochora.runtime.worldgen.DecayOnDeath"
            options {
              replacement = "CODE:0"  # TYPE:VALUE — dead cells become NOP (CODE:0)
            }
          },

          # --- Birth Handlers (mutation operators, applied to each newborn) ----------------
          { # Copies a code block from a random LABEL into an empty region
            className = "org.evochora.runtime.worldgen.GeneDuplicationPlugin"
            options {
              duplicationRate = 0.1  # probability per newborn
              minNopSize = 8         # minimum contiguous empty cells needed as target
            }
          },
          { # Removes a code block starting at a weighted-random LABEL
            className = "org.evochora.runtime.worldgen.GeneDeletionPlugin"
            options {
              deletionRate = 0.025   # probability per newborn
              countExponent = 2.0    # duplicate labels selected with weight = count^exponent
            }
          },
          { # Inserts syntactically correct instructions into empty regions
            className = "org.evochora.runtime.worldgen.GeneInsertionPlugin"
            options {
              mutationRate = 0.05  # probability per newborn
              entries = [
                {
                  instructions = "*"   # any instruction with type-correct arguments
                  weight = 3           # 3:1 ratio vs label entries → ~75% instruction insertions
                  args {
                    REGISTER { banks = ["DR"], range = [0, 7] }
                    LOCATION_REGISTER { range = [0, 3] }
                    DATA { min = 0, max = 255 }
                    LABELREF = "existing"
                    VECTOR = "unit"
                  }
                }
                {
                  type = "label"   # new label derived from existing with bit flips
                  weight = 1
                  bitflips = 2     # number of random bits to flip in 19-bit hash
                }
              ]
            }
          },
          { # Mutates a single molecule in-place (opcode flip, register ±1, bit-flip)
            className = "org.evochora.runtime.worldgen.GeneSubstitutionPlugin"
            options {
              substitutionRate = 0.025  # probability per newborn
              CODE {                    # flip to a different opcode
                weight = 1.0
                operationFlipWeight = 0.7  # same family, different operation
                familyFlipWeight = 0.2     # same operation, different family
                variantFlipWeight = 0.1    # same family+operation, different variant
              }
              REGISTER { weight = 1.0 }                # ±1 within bank boundaries
              DATA { weight = 1.0, exponent = 0.7 }    # scale-proportional perturbation
              LABEL { weight = 1.0, bitflips = 1 }     # random bit-flip in 19-bit hash
              LABELREF { weight = 1.0, bitflips = 1 }  # random bit-flip in 19-bit hash
            }
          }
        ] ${pipeline.core-plugins}
      }
    }
  }
}

# Logging configuration
logging {
  format = "PLAIN"
  default-level = "INFO"
  levels {
    #"org.evochora.datapipeline.services.SimulationEngine" = "DEBUG"
    #"org.evochora.datapipeline.services.PersistenceService" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.EnvironmentIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.OrganismIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.AnalyticsIndexer" = "DEBUG"
    #"org.evochora.compiler.Compiler" = "DEBUG"
  }
}
