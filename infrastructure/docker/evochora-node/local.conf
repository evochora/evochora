# local.conf for the Demo-System
# Mounted via docker-compose.override.yml as config/local.conf

# Inherits all base settings from evochora.conf
include "evochora.conf"

pipeline {
  autoStart = false
  startupSequence = ["environment-indexer-1", "organism-indexer-1", "analytics-indexer-1", "metadata-indexer", "metadata-persistence-service", "persistence-service-1", "simulation-engine"]
  #runId = "20260216-21270780-fc077723-3f36-43c7-8746-c7d39bcc383a"

  database {
    jdbcUrl = "jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=2097152;LOCK_TIMEOUT=10000"
  }

  resources {
    tick-storage {
      options {
        rootDirectory = "/home/appuser/app/data/storage"
      }
    }
  }

  services {
    simulation-engine {
      options {
        pauseTicks = [500000, 1000000, 1500000, 2000000, 2500000]
        seed = 42
        #samplingInterval = 1000
        #snapshotInterval = 10
        
        resume {
          #enabled = true
        }

        environment {
          shape = [3200, 1800]
        }

        # Runtime settings (NEW in v0.3.2)
        runtime {
          organism {
            max-energy = 150000
            max-entropy = 10000
            error-penalty-cost = 100
            max-skips-per-tick = 100
          }

          label-matching {
            options {
              # Stochastic selection among duplicate labels (half-weight distance)
              selectionSpread = 50
            }
          }
        }

        # Renamed from energyStrategies → tickPlugins (v0.3.2)
        plugins = [
          {
            className = "org.evochora.runtime.worldgen.SeedEnergyCreator"
            options {
              percentage = 0.001
              amount = 25000
              amountVariance = 0.2
            }
          },
          {
            className = "org.evochora.runtime.worldgen.GeyserCreator"
            options {
              count = 250
              interval = 100
              amount = 10000
              safetyRadius = 3
            }
          },
          {
            className = "org.evochora.runtime.worldgen.SolarRadiationCreator"
            options {
              probability = 0.01
              amount = 10000
              safetyRadius = 1
              executionsPerTick = 1
            }
          },
          {
            className = "org.evochora.runtime.worldgen.DecayOnDeath"
            options {
              # Molecule to replace dead organism's molecules with (TYPE:VALUE format)
              replacement = "CODE:0"
            }
          },
          {
            className = "org.evochora.runtime.worldgen.GeneDuplicationPlugin"
            options {
              duplicationRate = 0.2
              minNopSize = 8
            }
          },
          {
            className = "org.evochora.runtime.worldgen.GeneDeletionPlugin"
            options {
              deletionRate = 0.05
              countExponent = 2.0
            }
          },
          {
            className = "org.evochora.runtime.worldgen.GeneInsertionPlugin"
            options {
              mutationRate = 0.1

              entries = [
                {
                  instructions = "*"
                  weight = 3
                  args {
                    REGISTER { banks = ["DR"], range = [0, 7] }
                    LOCATION_REGISTER { range = [0, 3] }
                    DATA { min = 0, max = 255 }
                    LABELREF = "existing"
                    VECTOR = "unit"
                  }
                }
                {
                  type = "label"
                  weight = 1
                  bitflips = 2
                }
              ]
            }
          },
          {
            className = "org.evochora.runtime.worldgen.GeneSubstitutionPlugin"
            options {
              substitutionRate = 0.05

              CODE {
                weight = 1.0
                operationFlipWeight = 0.7    # same family+variant, different operation
                familyFlipWeight = 0.2       # same operation+variant, different family
                variantFlipWeight = 0.1      # same family+operation, different variant (same arity)
              }
              REGISTER {
                weight = 1.0                 # ±1 within bank boundaries
              }
              DATA {
                weight = 1.0
                exponent = 0.7               # delta = max(1, round(|value|^exponent))
              }
              LABEL {
                weight = 1.0
                bitflips = 1                 # number of random bits to flip in 19-bit hash
              }
              LABELREF {
                weight = 1.0
                bitflips = 1                 # number of random bits to flip in 19-bit hash
              }
            }
          },
          {
            className = "org.evochora.runtime.worldgen.LabelRewritePlugin"
            options {}
          }
        ]
      }
    }

    # # Indexers with different batch size
    # environment-indexer-1 { options { insertBatchSize = 100 } }
    # environment-indexer-2 { options { insertBatchSize = 100 } }
    # organism-indexer-1 { options { insertBatchSize = 100 } }
    # organism-indexer-2 { options { insertBatchSize = 100 } }
    # analytics-indexer-1 { options { insertBatchSize = 100 } }
    # analytics-indexer-2 { options { insertBatchSize = 100 } }

    # # Persistence services with different batch size
    #persistence-service-1 { options { maxBatchSize = 1 } }
    #persistence-service-2 { options { maxBatchSize = 1 } }
  }  
}

node {
  processes {
    http {
      options {
        network {
          host = "0.0.0.0"
        }
      }
    }
    h2-console {
      options {
        network {
          host = "0.0.0.0"
        }
        database {
          jdbcUrl = "jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=2097152"
        }
      }
    }
    h2-tcp-server {
      options {
        tcpAllowOthers = true
        database {
          jdbcUrl = "jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=2097152"
        }
      }
    }
  }
}

logging {
  format = "PLAIN"

  levels {
    #"org.evochora.runtime.worldgen.GeneDuplicationPlugin" = "DEBUG"
    #"org.evochora.runtime.worldgen.GeneDeletionPlugin" = "DEBUG"
    #"org.evochora.runtime.worldgen.GeneInsertionPlugin" = "DEBUG"
    #"org.evochora.runtime.worldgen.GeneSubstitutionPlugin" = "DEBUG"

    # Debug logging for resume investigation
    #"org.evochora.datapipeline.services.PersistenceService" = "DEBUG"
    #"org.evochora.datapipeline.resources.topics.ArtemisTopicResource" = "DEBUG"
    #"org.evochora.datapipeline.resources.topics.ArtemisTopicReaderDelegate" = "DEBUG"
    #"org.evochora.datapipeline.resources.topics.ArtemisTopicWriterDelegate" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.AnalyticsIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.EnvironmentIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.OrganismIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.MetadataIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.AbstractBatchIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.AbstractIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.components.MetadataReadingComponent" = "DEBUG"

    # Specific logger levels - override the default for particular components
    #"org.evochora.datapipeline.ServiceManager" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.DummyIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.EnvironmentIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.OrganismIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.indexers.AnalyticsIndexer" = "DEBUG"
    #"org.evochora.datapipeline.services.SimulationEngine" = "DEBUG"
    #"org.evochora.node.processes.http.HttpServerProcess" = "DEBUG"
    #"org.evochora.node.processes.http.api.OpenApiController" = "DEBUG"
    #"org.evochora.datapipeline.resources.database.H2Database" = "DEBUG"
    #"org.evochora.compiler.Compiler" = "DEBUG"
    
    # ===== Artemis Embedded Broker Logging =====
    # Artemis is SILENT by default (programmatic defaults in ArtemisTopicResource).
    # Uncomment below to enable verbose Artemis logging for debugging:
    #
    # Artemis core: startup, connections, message flow (very verbose at INFO)
    # Default: WARN (set programmatically if not configured here)
    #"org.apache.activemq.artemis" = "INFO"
    #
    # Artemis server: internal broker operations
    # Default: OFF (suppresses harmless "AMQ224016: Caught exception" errors during shutdown)
    # These errors occur when ACKs arrive after consumer sessions are closed - harmless race condition.
    # Set to ERROR if you want to see these messages for debugging.
    #"org.apache.activemq.artemis.core.server" = "ERROR"
    #
    # Artemis audit: connection/session/resource events (extremely verbose)
    # Default: OFF (set programmatically if not configured here)
    #"org.apache.activemq.audit.base" = "INFO"
    #"org.apache.activemq.audit.message" = "INFO"
    #"org.apache.activemq.audit.resource" = "INFO"
  }
}
