services:
  evochora:
    build:
      context: ../../..
      dockerfile: infrastructure/docker/evochora-node/Dockerfile
    image: ghcr.io/evochora/evochora:${IMAGE_TAG:-latest}
    # Add a security option to run the container without the restrictive
    # default AppArmor profile. This is necessary to allow the entrypoint script
    # to change the user ID (via gosu), which is blocked on some hardened systems.
    security_opt:
      - apparmor:unconfined
    # The user is now managed by the entrypoint.sh script to ensure correct permissions at runtime.
    # user: "${UID:-1000}:${GID:-1000}"
    # Ports are no longer published directly to the host.
    # The Caddy reverse proxy will handle all incoming traffic.
    # ports:
    #   - "80:8081"
    #   - "8082:8082"
    #   - "9092:9092"
    volumes:
      # Mount host directories into the container for persistent data
      - ./evochora-data/storage:/home/appuser/app/data/storage
      - ./evochora-data/database:/home/appuser/app/data/database
      # Mount the configuration file into the container's config directory (read-only)
      - ./evochora.conf:/home/appuser/app/config/evochora.conf:ro
    environment:
      # === JVM Options & Configuration Overrides via System Properties (-D) ===
      - >
        JAVA_OPTS=
        -Xmx16g
        -Dlogging.format=PLAIN
        -Dnode.processes.http.options.network.host=0.0.0.0
        -Dnode.processes.h2-console.options.network.host=0.0.0.0
        -Dnode.processes.h2-tcp-server.options.tcpAllowOthers=true
        -Dpipeline.autoStart=false
        -Dpipeline.database.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144;LOCK_TIMEOUT=10000"
        -Dpipeline.resources.tick-storage.options.rootDirectory="/home/appuser/app/data/storage"
        -Dpipeline.resources.batch-topic.options.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/topicdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144;LOCK_TIMEOUT=10000"
        -Dnode.processes.h2-console.options.database.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144"
        -Dnode.processes.h2-tcp-server.options.database.jdbcUrl="jdbc:h2:/home/appuser/app/data/database/indexdb;MODE=PostgreSQL;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;CACHE_SIZE=262144"

    restart: unless-stopped

  caddy:
    image: caddy:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # Required for HTTP/3
    volumes:
      # Mount the Caddy configuration file (read-only)
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # Persist Caddy's state, including acquired SSL certificates
      - caddy_data:/data
    environment:
      # The domain name for automatic HTTPS.
      # This will be read from the .env file on the server.
      - DOMAIN_NAME=${DOMAIN_NAME}
      - LOG_LEVEL=INFO

# Docker volume for persisting Caddy's data (e.g., SSL certs)
volumes:
  caddy_data: {}
